<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>JDR Compagnon</title>
    
    <!-- Styles: Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              fantasy: {
                dark: '#0f172a',
                panel: '#1e293b',
                gold: '#d97706',
                danger: '#ef4444',
                success: '#22c55e',
                text: '#e2e8f0',
                accent: '#3b82f6'
              }
            },
            animation: {
              'fade-in': 'fadeIn 0.3s ease-out'
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0', transform: 'translateY(10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              }
            }
          }
        }
      }
    </script>
    
    <!-- Icons: Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Import Map pour le SDK Gemini -->
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@^1.34.0"
      }
    }
    </script>

    <style>
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #0f172a; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }
      
      .input-std {
        background-color: transparent;
        border-bottom: 1px solid #475569;
        outline: none;
        transition: border-color 0.2s;
        color: #e2e8f0;
      }
      .input-std:focus { border-bottom-color: #d97706; }

      .glass-panel {
        background: rgba(30, 41, 59, 0.95);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
    </style>
</head>
<body class="bg-fantasy-dark text-fantasy-text min-h-screen font-sans overflow-hidden">
    
    <!-- Container Principal -->
    <div id="app" class="h-screen flex flex-col overflow-hidden">
        <div class="text-center text-slate-500 mt-20 animate-pulse">Chargement du grimoire...</div>
    </div>

    <!-- Modale de Gestion (Inventaire/Compétences) -->
    <div id="modal-container"></div>

    <!-- Logique de l'application -->
    <script type="module">
      import { GoogleGenAI, Type } from "@google/genai";
      
      // --- Configuration ---
      const API_KEY = (typeof process !== 'undefined' && process.env) ? process.env.API_KEY : '';
      const ai = new GoogleGenAI({ apiKey: API_KEY });

      // --- Données Initiales ---
      const CONDITIONS_LIST = ['Empoisonné', 'Étourdi', 'À terre', 'Aveuglé', 'Charmé', 'Béni'];
      
      const INITIAL_PLAYERS = [
        { 
          id: '1', name: 'Grommash', role: 'Barbare', isNpc: false, 
          stats: { pv: 45, maxPv: 45, dex: 12, iniBase: 2, iniRoll: 0 }, 
          notes: 'Rage disponible', conditions: [],
          skills: ['Athlétisme', 'Intimidation'],
          inventory: [
            { id: 'i1', name: 'Hache à deux mains', type: 'weapon', qty: 1 },
            { id: 'i2', name: 'Potion de Soin', type: 'item', qty: 2 }
          ]
        },
        { 
          id: '2', name: 'Elara', role: 'Mage', isNpc: false, 
          stats: { pv: 22, maxPv: 22, dex: 16, iniBase: 4, iniRoll: 0 }, 
          notes: 'Sorts niv 2', conditions: [],
          skills: ['Arcanes', 'Histoire'],
          inventory: [
            { id: 'i3', name: 'Bâton runique', type: 'weapon', qty: 1 },
            { id: 'i4', name: 'Parchemin vierge', type: 'item', qty: 5 }
          ]
        },
        { 
          id: '3', name: 'Gobelin Chef', role: 'Monstre', isNpc: true, 
          stats: { pv: 15, maxPv: 15, dex: 14, iniBase: 3, iniRoll: 0 }, 
          notes: 'Lâche', conditions: [],
          skills: ['Discrétion'],
          inventory: [
            { id: 'i5', name: 'Dague rouillée', type: 'weapon', qty: 1 }
          ]
        }
      ];

      // --- État Global ---
      let state = {
        players: [...INITIAL_PLAYERS],
        viewMode: 'GM', // 'GM' | 'PLAYER_SELECT' | 'PLAYER_FOCUS'
        selectedPlayerId: null, // Pour la vue joueur focus
        editingPlayerId: null, // Pour la modale GM
        isGenerating: false,
        isChatOpen: true,
        chatMessages: [
          { role: 'system', text: 'Bienvenue, Maître du Jeu. Je suis votre assistant. Demandez-moi de générer du butin, des PNJ ou des descriptions.' }
        ],
        chatInput: ''
      };

      // --- Services Gemini ---
      async function askAI(prompt) {
        if (!API_KEY) return addChatMessage('system', "Clé API manquante.");
        
        addChatMessage('user', prompt);
        updateState({ isGenerating: true });

        try {
          const context = `Contexte JDR: ${state.players.map(p => `${p.name} (${p.role})`).join(', ')}.`;
          const response = await ai.models.generateContent({
            model: 'gemini-3-flash-preview',
            contents: `${context} \n ${prompt}`,
            config: { maxOutputTokens: 300 }
          });
          addChatMessage('ai', response.text);
        } catch (e) {
          console.error(e);
          addChatMessage('system', "L'oracle est confus (Erreur API).");
        }
        updateState({ isGenerating: false });
      }

      function addChatMessage(role, text) {
        state.chatMessages = [...state.chatMessages, { role, text, time: new Date() }];
        renderChat(); // Re-render chat only for performance
        scrollToBottom();
      }

      function scrollToBottom() {
        const chatBody = document.getElementById('chat-body');
        if (chatBody) chatBody.scrollTop = chatBody.scrollHeight;
      }

      async function generateNpc() {
        // ... (Code existant simplifié pour brièveté, mais fonctionnel)
        if (!API_KEY) { alert("API Key manquante"); return; }
        updateState({ isGenerating: true });
        try {
           const response = await ai.models.generateContent({
            model: 'gemini-3-flash-preview',
            contents: `Génère un PNJ fantasy JSON: name, role, stats(maxPv, dex, iniBase).`,
            config: { responseMimeType: "application/json" }
          });
          const npcData = JSON.parse(response.text);
          if (npcData.name) {
             addPlayer({
                id: crypto.randomUUID(), name: npcData.name, role: npcData.role || 'PNJ', isNpc: true,
                stats: { pv: npcData.stats?.maxPv||10, maxPv: npcData.stats?.maxPv||10, dex: npcData.stats?.dex||10, iniBase: npcData.stats?.iniBase||0, iniRoll: 0 },
                notes: '', conditions: [], skills: [], inventory: []
             });
             addChatMessage('system', `Nouveau PNJ généré: ${npcData.name}`);
          }
        } catch(e) { console.error(e); }
        updateState({ isGenerating: false });
      }

      // --- Gestion de l'état ---
      function updateState(newState) {
        state = { ...state, ...newState };
        render();
      }

      // --- Rendu Principal ---
      function render() {
        const app = document.getElementById('app');
        
        const header = `
          <header class="flex-none bg-slate-900 border-b border-slate-700 p-4 flex justify-between items-center shadow-md z-20">
            <div class="flex items-center gap-3">
                <div class="bg-fantasy-gold p-2 rounded-lg shadow-lg shadow-amber-500/20">
                    <i data-lucide="sword" class="text-white w-5 h-5"></i>
                </div>
                <h1 class="text-xl md:text-2xl font-extrabold tracking-tight text-white hidden md:block">
                    JDR <span class="text-fantasy-gold">Compagnon</span>
                </h1>
            </div>
            
            <div class="flex items-center gap-4">
              <div class="flex bg-slate-800 rounded-lg p-1 border border-slate-700">
                <button onclick="window.appActions.setView('GM')" 
                  class="px-3 py-1.5 rounded text-xs font-bold uppercase tracking-wider transition-all flex items-center gap-2 ${state.viewMode === 'GM' ? 'bg-fantasy-panel text-fantasy-gold shadow' : 'text-slate-400 hover:text-white'}">
                  <i data-lucide="crown" class="w-4 h-4"></i> MJ
                </button>
                <button onclick="window.appActions.setView('PLAYER_SELECT')" 
                  class="px-3 py-1.5 rounded text-xs font-bold uppercase tracking-wider transition-all flex items-center gap-2 ${state.viewMode.startsWith('PLAYER') ? 'bg-fantasy-panel text-fantasy-gold shadow' : 'text-slate-400 hover:text-white'}">
                   <i data-lucide="users" class="w-4 h-4"></i> Joueur
                </button>
              </div>
              
              <button onclick="window.appActions.toggleChat()" class="text-slate-400 hover:text-fantasy-gold relative">
                 <i data-lucide="message-square" class="w-6 h-6"></i>
                 ${state.isChatOpen ? '' : '<span class="absolute top-0 right-0 w-2 h-2 bg-fantasy-gold rounded-full"></span>'}
              </button>
            </div>
          </header>
        `;

        // Corps principal
        let mainContent = '';
        if (state.viewMode === 'GM') {
            mainContent = renderGMView();
        } else if (state.viewMode === 'PLAYER_SELECT') {
            mainContent = renderPlayerSelect();
        } else if (state.viewMode === 'PLAYER_FOCUS') {
            mainContent = renderPlayerFocus();
        }

        app.innerHTML = `
          ${header}
          <div class="flex flex-1 overflow-hidden relative">
            <main class="flex-1 overflow-y-auto p-4 md:p-8 relative">
               ${mainContent}
            </main>
            
            <!-- Chat Panel -->
            <aside class="${state.isChatOpen ? 'w-80 translate-x-0' : 'w-0 translate-x-full'} transition-all duration-300 bg-slate-900 border-l border-slate-700 flex flex-col absolute right-0 top-0 bottom-0 z-30 shadow-2xl md:relative md:transform-none">
               ${renderChat()}
            </aside>
          </div>
        `;

        renderModal();
        lucide.createIcons();
        
        // Restore focus if typing in chat
        if(document.activeElement?.id === 'chat-input') {
             document.getElementById('chat-input').focus();
        }
      }

      // --- Vues ---

      function renderGMView() {
        return `
          <div class="space-y-6 max-w-6xl mx-auto animate-fade-in pb-20">
            <!-- Toolbar -->
            <div class="flex flex-wrap gap-4 items-center justify-between bg-fantasy-panel p-4 rounded-lg border border-slate-700 shadow-sm">
                <div class="flex gap-2 w-full md:w-auto">
                  <input type="text" id="newPlayerInput" placeholder="Nouveau personnage..." class="bg-slate-800 border border-slate-600 text-white px-3 py-2 rounded text-sm focus:border-fantasy-gold outline-none flex-1">
                  <button onclick="window.appActions.addManualPlayer()" class="bg-fantasy-gold text-white hover:bg-yellow-600 px-3 py-2 rounded shadow-md"><i data-lucide="plus" class="w-4 h-4"></i></button>
                  <button onclick="window.appActions.createNpc()" class="bg-indigo-600 text-white hover:bg-indigo-700 px-3 py-2 rounded shadow-md flex items-center gap-1 text-xs font-bold uppercase"><i data-lucide="wand-2" class="w-4 h-4"></i> PNJ IA</button>
                </div>
                <button onclick="window.appActions.sortInitiative()" class="bg-slate-700 text-slate-200 hover:bg-slate-600 px-4 py-2 rounded text-sm font-medium shadow-md border border-slate-600 flex items-center gap-2">
                   <i data-lucide="arrow-down-narrow-wide" class="w-4 h-4"></i> Trier Initiative
                </button>
            </div>

            <!-- Table -->
            <div class="overflow-x-auto bg-fantasy-panel rounded-lg shadow-xl border border-slate-700">
                <table class="w-full text-left text-sm whitespace-nowrap">
                  <thead class="bg-slate-800 text-slate-400 uppercase font-bold text-xs">
                    <tr>
                      <th class="p-4 w-12 text-center">Ini</th>
                      <th class="p-4">Héros</th>
                      <th class="p-4 text-center">Santé (PV)</th>
                      <th class="p-4 text-center">Défense/Dex</th>
                      <th class="p-4">États</th>
                      <th class="p-4 text-right">Gestion</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-700">
                    ${state.players.map((p, idx) => renderGMRow(p, idx)).join('')}
                  </tbody>
                </table>
            </div>
          </div>
        `;
      }

      function renderGMRow(player, index) {
        const isDead = player.stats.pv <= 0;
        return `
          <tr class="hover:bg-slate-700/50 transition-colors ${isDead ? 'opacity-50 grayscale' : ''}">
            <td class="p-3 text-center">
               <div class="flex items-center justify-center gap-1">
                 <input type="number" value="${player.stats.iniRoll}" onchange="window.appActions.updateStat('${player.id}', 'iniRoll', parseInt(this.value))" class="w-10 text-center bg-slate-900 border border-slate-600 rounded py-1 text-fantasy-gold font-bold">
                 <span class="text-xs text-slate-500">+ ${player.stats.iniBase}</span>
               </div>
            </td>
            <td class="p-3">
               <input value="${player.name}" onchange="window.appActions.updatePlayer('${player.id}', 'name', this.value)" class="input-std font-bold block w-full text-slate-200">
               <input value="${player.role}" onchange="window.appActions.updatePlayer('${player.id}', 'role', this.value)" class="input-std text-xs text-slate-400 block w-full mt-1">
            </td>
            <td class="p-3 text-center">
              <div class="flex items-center justify-center gap-1 bg-slate-900/50 rounded-full px-2 py-1 border border-slate-700 inline-flex">
                 <button onclick="window.appActions.updateStat('${player.id}', 'pv', ${player.stats.pv - 1})" class="text-red-400 hover:text-red-300 p-1"><i data-lucide="minus" class="w-3 h-3"></i></button>
                 <span class="font-mono font-bold w-8 text-right ${player.stats.pv < player.stats.maxPv/2 ? 'text-red-500' : 'text-green-400'}">${player.stats.pv}</span>
                 <span class="text-slate-500 text-xs">/</span>
                 <input type="number" value="${player.stats.maxPv}" onchange="window.appActions.updateStat('${player.id}', 'maxPv', parseInt(this.value))" class="w-8 bg-transparent text-slate-500 text-xs outline-none">
                 <button onclick="window.appActions.updateStat('${player.id}', 'pv', ${player.stats.pv + 1})" class="text-green-400 hover:text-green-300 p-1"><i data-lucide="plus" class="w-3 h-3"></i></button>
              </div>
            </td>
            <td class="p-3 text-center">
               <input type="number" value="${player.stats.dex}" onchange="window.appActions.updateStat('${player.id}', 'dex', parseInt(this.value))" class="w-12 text-center bg-transparent border-b border-slate-700 text-slate-300">
            </td>
            <td class="p-3">
               <div class="flex flex-wrap gap-1 mb-1 max-w-[200px]">
                 ${player.conditions.map(c => `
                   <span class="text-[10px] bg-slate-800 text-red-300 px-2 py-0.5 rounded-full border border-red-900/50 cursor-pointer hover:bg-red-900" onclick="window.appActions.removeCondition('${player.id}', '${c}')">
                     ${c}
                   </span>
                 `).join('')}
               </div>
               <select onchange="window.appActions.addCondition('${player.id}', this.value)" class="bg-transparent text-xs text-slate-500 outline-none w-20 hover:text-slate-300">
                 <option value="">+ État</option>
                 ${CONDITIONS_LIST.map(c => `<option value="${c}">${c}</option>`).join('')}
               </select>
            </td>
            <td class="p-3 text-right">
              <button onclick="window.appActions.editPlayer('${player.id}')" class="text-fantasy-gold hover:text-white mr-2 p-2 hover:bg-slate-700 rounded"><i data-lucide="settings-2" class="w-4 h-4"></i></button>
              <button onclick="window.appActions.removePlayer('${player.id}')" class="text-slate-600 hover:text-red-500 p-2 hover:bg-slate-700 rounded"><i data-lucide="trash" class="w-4 h-4"></i></button>
            </td>
          </tr>
        `;
      }

      function renderPlayerSelect() {
        return `
          <div class="flex flex-col items-center justify-center h-full animate-fade-in">
             <h2 class="text-3xl font-bold text-white mb-8">Qui incarnez-vous ?</h2>
             <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 max-w-4xl w-full px-4">
               ${state.players.filter(p => !p.isNpc).map(p => `
                 <button onclick="window.appActions.selectPlayer('${p.id}')" class="group relative bg-fantasy-panel border-2 border-slate-700 hover:border-fantasy-gold rounded-xl p-8 transition-all hover:scale-105 hover:shadow-2xl hover:shadow-fantasy-gold/20 text-left">
                    <h3 class="text-2xl font-bold text-white group-hover:text-fantasy-gold">${p.name}</h3>
                    <p class="text-slate-400">${p.role}</p>
                    <div class="absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="arrow-right" class="w-6 h-6 text-fantasy-gold"></i>
                    </div>
                 </button>
               `).join('')}
             </div>
             <p class="mt-8 text-slate-500 text-sm">Sélectionnez votre fiche pour accéder à la vue simplifiée.</p>
          </div>
        `;
      }

      function renderPlayerFocus() {
        const player = state.players.find(p => p.id === state.selectedPlayerId);
        if (!player) return `<div class="text-center mt-20">Joueur introuvable <button onclick="window.appActions.setView('PLAYER_SELECT')">Retour</button></div>`;
        
        const hpPercent = (player.stats.pv / player.stats.maxPv) * 100;

        return `
          <div class="max-w-md mx-auto h-full flex flex-col gap-6 animate-fade-in pb-10">
             <button onclick="window.appActions.setView('PLAYER_SELECT')" class="text-slate-500 hover:text-white flex items-center gap-2 text-sm uppercase font-bold tracking-widest mb-4">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Changer de perso
             </button>

             <!-- Header Carte -->
             <div class="text-center space-y-2">
                <h2 class="text-4xl font-extrabold text-white tracking-tight">${player.name}</h2>
                <p class="text-fantasy-gold uppercase tracking-widest text-sm font-semibold">${player.role}</p>
             </div>

             <!-- Big PV -->
             <div class="glass-panel p-8 rounded-2xl shadow-2xl relative overflow-hidden border-t-4 ${hpPercent < 30 ? 'border-red-500' : 'border-green-500'}">
                <div class="flex justify-between items-end mb-4 relative z-10">
                   <span class="text-slate-400 font-bold text-sm uppercase">Points de Vie</span>
                   <span class="text-5xl font-black text-white">${player.stats.pv} <span class="text-lg text-slate-500 font-normal">/ ${player.stats.maxPv}</span></span>
                </div>
                
                <div class="h-4 bg-slate-900 rounded-full overflow-hidden mb-6 border border-slate-700">
                    <div class="h-full transition-all duration-700 ${hpPercent < 30 ? 'bg-red-500' : 'bg-green-500'}" style="width: ${hpPercent}%"></div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="window.appActions.updateStat('${player.id}', 'pv', ${player.stats.pv - 1})" class="bg-slate-800 hover:bg-red-900/50 border border-slate-700 text-red-400 py-3 rounded-lg font-bold text-xl flex items-center justify-center transition-colors">
                        -1 PV
                    </button>
                     <!-- Note: Player can't heal themselves easily in this view, meant to be succinct. GM handles heals or items usage -->
                    <div class="text-center flex flex-col justify-center bg-slate-800/50 rounded-lg border border-slate-700/50">
                        <span class="text-xs text-slate-400 uppercase">État</span>
                        <span class="font-bold ${player.conditions.length ? 'text-red-400' : 'text-green-400'}">${player.conditions.length > 0 ? player.conditions[0] : 'Sain'}</span>
                    </div>
                </div>
             </div>

             <!-- Inventaire Succinct -->
             <div class="bg-fantasy-panel rounded-xl border border-slate-700 p-4 flex-1">
                <h3 class="text-slate-400 text-xs font-bold uppercase mb-4 flex items-center gap-2"><i data-lucide="backpack" class="w-4 h-4"></i> Équipement Rapide</h3>
                <ul class="space-y-3">
                   ${player.inventory.length === 0 ? '<li class="text-slate-600 italic text-sm text-center py-4">Sac vide...</li>' : ''}
                   ${player.inventory.map(item => `
                     <li class="flex justify-between items-center text-slate-300 border-b border-slate-800 pb-2 last:border-0">
                        <div class="flex items-center gap-3">
                            <div class="bg-slate-800 p-2 rounded text-slate-500">
                                <i data-lucide="${item.type === 'weapon' ? 'sword' : 'package'}" class="w-4 h-4"></i>
                            </div>
                            <span>${item.name}</span>
                        </div>
                        <span class="font-mono text-fantasy-gold font-bold">x${item.qty}</span>
                     </li>
                   `).join('')}
                </ul>
             </div>
          </div>
        `;
      }

      function renderChat() {
        const messagesHtml = state.chatMessages.map(msg => `
            <div class="mb-4 ${msg.role === 'user' ? 'text-right' : 'text-left'}">
                <div class="inline-block max-w-[90%] p-3 rounded-lg text-sm ${
                    msg.role === 'user' ? 'bg-fantasy-gold text-white rounded-br-none' : 
                    msg.role === 'system' ? 'bg-slate-800 text-slate-400 text-xs italic border border-slate-700' : 
                    'bg-slate-700 text-slate-200 rounded-bl-none border border-slate-600'
                }">
                    ${msg.role === 'ai' ? `<div class="text-fantasy-gold text-[10px] font-bold mb-1 uppercase tracking-wider flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3"></i> Oracle</div>` : ''}
                    ${msg.text}
                </div>
            </div>
        `).join('');

        return `
            <div class="flex flex-col h-full bg-slate-900">
                <div class="p-3 border-b border-slate-700 flex justify-between items-center bg-slate-800">
                    <h3 class="font-bold text-slate-200 flex items-center gap-2 text-sm"><i data-lucide="scroll" class="w-4 h-4"></i> Journal & Oracle</h3>
                    <button onclick="window.appActions.toggleChat()" class="md:hidden text-slate-400"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <div id="chat-body" class="flex-1 overflow-y-auto p-4 bg-slate-900/50">
                    ${messagesHtml}
                    ${state.isGenerating ? '<div class="text-xs text-fantasy-gold animate-pulse">L\'oracle réfléchit...</div>' : ''}
                </div>
                <form onsubmit="window.appActions.sendChat(event)" class="p-3 bg-slate-800 border-t border-slate-700 flex gap-2">
                    <input id="chat-input" autocomplete="off" placeholder="Noter un truc ou demander à l'IA..." class="flex-1 bg-slate-900 border border-slate-600 text-white text-sm rounded px-3 py-2 outline-none focus:border-fantasy-gold placeholder-slate-600">
                    <button type="submit" class="bg-fantasy-gold text-white p-2 rounded hover:bg-yellow-600 transition-colors"><i data-lucide="send" class="w-4 h-4"></i></button>
                </form>
            </div>
        `;
      }

      function renderModal() {
        const container = document.getElementById('modal-container');
        if (!state.editingPlayerId) {
            container.innerHTML = '';
            return;
        }

        const player = state.players.find(p => p.id === state.editingPlayerId);
        if (!player) return;

        container.innerHTML = `
          <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
             <div class="bg-fantasy-panel w-full max-w-2xl max-h-[90vh] overflow-hidden rounded-xl border border-slate-600 shadow-2xl flex flex-col">
                <!-- Header -->
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800">
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <i data-lucide="settings-2" class="w-5 h-5 text-fantasy-gold"></i> 
                        Gestion: ${player.name}
                    </h2>
                    <button onclick="window.appActions.closeModal()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>

                <!-- Body (Scrollable) -->
                <div class="p-6 overflow-y-auto space-y-8 custom-scrollbar">
                    
                    <!-- Section Inventaire -->
                    <div>
                        <h3 class="text-sm font-bold text-fantasy-gold uppercase tracking-widest mb-3 border-b border-slate-700 pb-1">Inventaire</h3>
                        <div class="space-y-2 mb-4">
                            ${player.inventory.map(item => `
                                <div class="flex items-center justify-between bg-slate-900/50 p-2 rounded border border-slate-700/50">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="${item.type === 'weapon' ? 'sword' : 'package'}" class="w-4 h-4 text-slate-500"></i>
                                        <span class="text-slate-200">${item.name}</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center bg-slate-800 rounded">
                                            <button onclick="window.appActions.updateItemQty('${player.id}', '${item.id}', -1)" class="px-2 text-slate-400 hover:text-white">-</button>
                                            <span class="w-6 text-center text-sm font-mono">${item.qty}</span>
                                            <button onclick="window.appActions.updateItemQty('${player.id}', '${item.id}', 1)" class="px-2 text-slate-400 hover:text-white">+</button>
                                        </div>
                                        <button onclick="window.appActions.deleteItem('${player.id}', '${item.id}')" class="text-red-900 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <form onsubmit="window.appActions.addItem(event, '${player.id}')" class="flex gap-2">
                            <input name="itemName" placeholder="Nouvel objet..." class="flex-1 bg-slate-800 border border-slate-600 rounded px-3 py-1 text-sm text-white outline-none focus:border-fantasy-gold" required>
                            <select name="itemType" class="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm text-slate-300 outline-none">
                                <option value="item">Objet</option>
                                <option value="weapon">Arme</option>
                            </select>
                            <button type="submit" class="bg-fantasy-gold text-white px-3 py-1 rounded text-sm hover:bg-yellow-600">Ajouter</button>
                        </form>
                    </div>

                    <!-- Section Compétences -->
                    <div>
                        <h3 class="text-sm font-bold text-fantasy-gold uppercase tracking-widest mb-3 border-b border-slate-700 pb-1">Compétences</h3>
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${player.skills.map(skill => `
                                <span class="bg-slate-800 text-slate-200 px-3 py-1 rounded-full text-sm border border-slate-600 flex items-center gap-2">
                                    ${skill}
                                    <button onclick="window.appActions.removeSkill('${player.id}', '${skill}')" class="text-slate-500 hover:text-red-400">&times;</button>
                                </span>
                            `).join('')}
                        </div>
                        <form onsubmit="window.appActions.addSkill(event, '${player.id}')" class="flex gap-2">
                            <input name="skillName" placeholder="Nouvelle compétence..." class="flex-1 bg-slate-800 border border-slate-600 rounded px-3 py-1 text-sm text-white outline-none focus:border-fantasy-gold" required>
                            <button type="submit" class="bg-fantasy-panel border border-slate-500 text-slate-300 px-3 py-1 rounded text-sm hover:bg-slate-700">Ajouter</button>
                        </form>
                    </div>

                    <!-- Notes -->
                    <div>
                         <h3 class="text-sm font-bold text-fantasy-gold uppercase tracking-widest mb-3 border-b border-slate-700 pb-1">Notes Publiques</h3>
                         <textarea onchange="window.appActions.updatePlayer('${player.id}', 'notes', this.value)" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-slate-300 text-sm h-24 focus:border-fantasy-gold outline-none resize-none" placeholder="Notes visibles par tous...">${player.notes}</textarea>
                    </div>
                </div>
             </div>
          </div>
        `;
      }

      // --- Actions ---
      window.appActions = {
        setView: (mode) => {
            // Si on quitte le mode Focus, on reset la selection
            if(mode === 'PLAYER_SELECT') updateState({ viewMode: mode, selectedPlayerId: null });
            else updateState({ viewMode: mode });
        },
        toggleChat: () => updateState({ isChatOpen: !state.isChatOpen }),
        
        selectPlayer: (id) => updateState({ selectedPlayerId: id, viewMode: 'PLAYER_FOCUS' }),
        
        editPlayer: (id) => updateState({ editingPlayerId: id }),
        closeModal: () => updateState({ editingPlayerId: null }),

        updatePlayer: (id, field, value) => {
          const players = state.players.map(p => p.id === id ? { ...p, [field]: value } : p);
          updateState({ players });
        },

        updateStat: (id, stat, value) => {
          const players = state.players.map(p => {
             if (p.id !== id) return p;
             let newValue = value;
             if (stat === 'pv') newValue = Math.min(p.stats.maxPv, Math.max(0, value));
             return { ...p, stats: { ...p.stats, [stat]: newValue } };
          });
          updateState({ players });
        },

        addCondition: (id, condition) => {
          if (!condition) return;
          const players = state.players.map(p => {
            if (p.id !== id || p.conditions.includes(condition)) return p;
            return { ...p, conditions: [...p.conditions, condition] };
          });
          updateState({ players });
        },

        removeCondition: (id, condition) => {
          const players = state.players.map(p => 
            p.id === id ? { ...p, conditions: p.conditions.filter(c => c !== condition) } : p
          );
          updateState({ players });
        },

        removePlayer: (id) => {
          if(confirm('Supprimer ce personnage ?')) {
            updateState({ players: state.players.filter(p => p.id !== id) });
          }
        },

        sortInitiative: () => {
          const players = [...state.players].sort((a, b) => {
             return (b.stats.iniBase + b.stats.iniRoll) - (a.stats.iniBase + a.stats.iniRoll);
          });
          updateState({ players });
        },

        addManualPlayer: () => {
          const input = document.getElementById('newPlayerInput');
          const name = input.value.trim();
          if (!name) return;
          addPlayer({
            id: crypto.randomUUID(), name, role: 'Inconnu', isNpc: true,
            stats: { pv: 20, maxPv: 20, dex: 10, iniBase: 0, iniRoll: 0 },
            notes: '', conditions: [], skills: [], inventory: []
          });
          input.value = '';
        },
        createNpc: generateNpc,

        // Inventory & Skills Logic
        addItem: (e, playerId) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newItem = {
                id: crypto.randomUUID(),
                name: formData.get('itemName'),
                type: formData.get('itemType'),
                qty: 1
            };
            const players = state.players.map(p => p.id === playerId ? { ...p, inventory: [...p.inventory, newItem] } : p);
            updateState({ players });
            e.target.reset();
            renderModal(); // Force refresh modal content
        },
        updateItemQty: (playerId, itemId, change) => {
            const players = state.players.map(p => {
                if (p.id !== playerId) return p;
                const newInventory = p.inventory.map(i => {
                    if (i.id !== itemId) return i;
                    return { ...i, qty: Math.max(0, i.qty + change) };
                }).filter(i => i.qty > 0); // Remove if 0 ? Maybe better keep 0. Let's keep 0 but remove via trash icon only.
                return { ...p, inventory: newInventory };
            });
            updateState({ players });
            renderModal();
        },
        deleteItem: (playerId, itemId) => {
            const players = state.players.map(p => {
                if(p.id !== playerId) return p;
                return { ...p, inventory: p.inventory.filter(i => i.id !== itemId) };
            });
            updateState({ players });
            renderModal();
        },
        addSkill: (e, playerId) => {
            e.preventDefault();
            const val = new FormData(e.target).get('skillName');
            if(!val) return;
            const players = state.players.map(p => p.id === playerId ? { ...p, skills: [...p.skills, val] } : p);
            updateState({ players });
            e.target.reset();
            renderModal();
        },
        removeSkill: (playerId, skillName) => {
            const players = state.players.map(p => p.id === playerId ? { ...p, skills: p.skills.filter(s => s !== skillName) } : p);
            updateState({ players });
            renderModal();
        },

        // Chat
        sendChat: (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;
            
            // Check if asking AI
            if (text.toLowerCase().startsWith('/ai') || text.toLowerCase().startsWith('/oracle') || state.viewMode === 'GM') {
               // In GM mode, everything is assumed to be relevant to the game log, but let's make explicit calls to AI
               // Simplified: If text starts with '?' call AI, otherwise Log.
               if(text.startsWith('?')) {
                   askAI(text.substring(1).trim());
               } else {
                   addChatMessage('user', text); // Juste un log
               }
            } else {
               addChatMessage('user', text);
            }
            input.value = '';
        }
      };

      function addPlayer(player) {
        updateState({ players: [...state.players, player] });
      }

      // Initial Render
      render();
    </script>
</body>
</html>