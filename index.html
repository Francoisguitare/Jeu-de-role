<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>JDR Compagnon</title>
    
    <!-- Styles: Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              fantasy: {
                dark: '#0f172a',
                panel: '#1e293b',
                gold: '#d97706',
                danger: '#ef4444',
                success: '#22c55e',
                text: '#e2e8f0',
                accent: '#3b82f6'
              }
            },
            animation: {
              'fade-in': 'fadeIn 0.3s ease-out',
              'highlight': 'highlightPulse 1.5s ease-out'
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0', transform: 'translateY(10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              },
              highlightPulse: {
                '0%': { backgroundColor: 'rgba(217, 119, 6, 0.6)', transform: 'scale(1.1)' },
                '100%': { backgroundColor: 'transparent', transform: 'scale(1)' },
              }
            }
          }
        }
      }
    </script>
    
    <!-- Icons: Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Import Map pour le SDK Gemini -->
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@^1.34.0"
      }
    }
    </script>

    <style>
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #0f172a; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }
      
      /* Inputs invisibles qui se révèlent au focus */
      .input-ghost {
        background-color: transparent;
        border: 1px solid transparent;
        border-radius: 0.25rem;
        transition: all 0.2s;
        text-align: center;
        width: 100%;
        color: inherit;
        font-family: inherit;
      }
      .input-ghost:hover {
        background-color: rgba(255, 255, 255, 0.05);
      }
      .input-ghost:focus {
        background-color: rgba(15, 23, 42, 0.8);
        border-color: #d97706;
        outline: none;
      }

      .input-ghost-left {
        text-align: left;
      }

      .glass-panel {
        background: rgba(30, 41, 59, 0.95);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      /* Animation class injectée dynamiquement */
      .flash-update {
        animation: highlightPulse 1s ease-out forwards;
      }
    </style>
</head>
<body class="bg-fantasy-dark text-fantasy-text min-h-screen font-sans overflow-hidden">
    
    <!-- Container Principal -->
    <div id="app" class="h-screen flex flex-col overflow-hidden">
        <div class="text-center text-slate-500 mt-20 animate-pulse">Chargement du grimoire...</div>
    </div>

    <!-- Modale de Gestion (Inventaire/Compétences) -->
    <div id="modal-container"></div>

    <!-- Logique de l'application -->
    <script type="module">
      import { GoogleGenAI, Type } from "@google/genai";
      
      // --- Configuration ---
      const API_KEY = (typeof process !== 'undefined' && process.env) ? process.env.API_KEY : '';
      const ai = new GoogleGenAI({ apiKey: API_KEY });

      // --- Données Initiales ---
      const CONDITIONS_LIST = ['Empoisonné', 'Étourdi', 'À terre', 'Aveuglé', 'Charmé', 'Béni', 'Maudit'];
      
      // Stats étendues pour un vrai JDR
      const INITIAL_PLAYERS = [
        { 
          id: '1', name: 'Grommash', role: 'Barbare', isNpc: false, 
          level: 3, xp: 1250,
          stats: { 
            pv: 45, maxPv: 45, ca: 14, iniBase: 2, iniRoll: 0,
            str: 18, dex: 14, con: 16, int: 8, wis: 10, cha: 12
          }, 
          notes: 'Rage disponible (2/jour)', conditions: [],
          skills: ['Athlétisme', 'Intimidation'],
          inventory: [
            { id: 'i1', name: 'Hache à deux mains', type: 'weapon', qty: 1, data: { atk: '+6', dmg: '1d12+4', crit: 'x3' } },
            { id: 'i2', name: 'Potion de Soin', type: 'item', qty: 2 }
          ],
          spells: []
        },
        { 
          id: '2', name: 'Elara', role: 'Mage', isNpc: false, 
          level: 3, xp: 1300,
          stats: { 
            pv: 22, maxPv: 22, ca: 11, iniBase: 4, iniRoll: 0,
            str: 8, dex: 16, con: 12, int: 18, wis: 14, cha: 10
          }, 
          notes: 'Sorts niv 2 débloqués', conditions: [],
          skills: ['Arcanes', 'Histoire'],
          inventory: [
            { id: 'i3', name: 'Bâton runique', type: 'weapon', qty: 1, data: { atk: '+2', dmg: '1d6', crit: 'x2' } },
            { id: 'i4', name: 'Parchemin vierge', type: 'item', qty: 5 }
          ],
          spells: [
            { id: 's1', name: 'Projectile Magique', level: 1, desc: '3 fléchettes infaillibles', dmg: '3x(1d4+1)', effect: 'Force' },
            { id: 's2', name: 'Bouclier', level: 1, desc: 'Réaction, +5 CA', dmg: '-', effect: 'Défense' }
          ]
        },
        { 
          id: '3', name: 'Gobelin Chef', role: 'Monstre', isNpc: true, 
          level: 2, xp: 400,
          stats: { 
            pv: 15, maxPv: 15, ca: 13, iniBase: 3, iniRoll: 0,
            str: 10, dex: 14, con: 10, int: 10, wis: 8, cha: 8
          }, 
          notes: 'Lâche, fuit si PV < 5', conditions: [],
          skills: ['Discrétion'],
          inventory: [
            { id: 'i5', name: 'Dague rouillée', type: 'weapon', qty: 1, data: { atk: '+4', dmg: '1d4+2', crit: 'x2' } }
          ],
          spells: []
        }
      ];

      // --- État Global ---
      let state = {
        players: [...INITIAL_PLAYERS],
        viewMode: 'GM', // 'GM' | 'PLAYER_SELECT' | 'PLAYER_FOCUS'
        selectedPlayerId: null,
        editingPlayerId: null,
        lastUpdated: { id: null, field: null, time: 0 }, // Pour l'animation
        isGenerating: false,
        isChatOpen: true,
        chatMessages: [
          { role: 'system', text: 'Bienvenue. Cliquez sur les statistiques pour les éditer directement.' }
        ],
        chatInput: ''
      };

      // --- Services Gemini ---
      async function askAI(prompt) {
        if (!API_KEY) return addChatMessage('system', "Clé API manquante.");
        addChatMessage('user', prompt);
        updateState({ isGenerating: true });
        try {
          const context = `Contexte JDR: ${state.players.map(p => `${p.name} (Niv ${p.level} ${p.role})`).join(', ')}.`;
          const response = await ai.models.generateContent({
            model: 'gemini-3-flash-preview',
            contents: `${context} \n ${prompt}`,
            config: { maxOutputTokens: 300 }
          });
          addChatMessage('ai', response.text);
        } catch (e) {
          addChatMessage('system', "Erreur API.");
        }
        updateState({ isGenerating: false });
      }

      function addChatMessage(role, text) {
        state.chatMessages = [...state.chatMessages, { role, text, time: new Date() }];
        
        // Optimisation: mise à jour ciblée pour éviter le re-render complet qui fait perdre le focus
        const chatWrapper = document.getElementById('chat-container-wrapper');
        if (chatWrapper) {
            chatWrapper.innerHTML = renderChat();
            lucide.createIcons();
            // Restore focus if sending a message
            if (role === 'user') {
                const input = document.getElementById('chat-input');
                if (input) input.focus();
            }
        } else {
            render();
        }
        scrollToBottom();
      }

      function scrollToBottom() {
        const chatBody = document.getElementById('chat-body');
        if (chatBody) chatBody.scrollTop = chatBody.scrollHeight;
      }

      async function generateNpc() {
        if (!API_KEY) { alert("API Key manquante"); return; }
        updateState({ isGenerating: true });
        try {
           const response = await ai.models.generateContent({
            model: 'gemini-3-flash-preview',
            contents: `Génère un PNJ fantasy JSON avec stats D&D 5e: name, role, level, stats(maxPv, ca, str, dex, con, int, wis, cha, iniBase).`,
            config: { responseMimeType: "application/json" }
          });
          const npcData = JSON.parse(response.text);
          if (npcData.name) {
             addPlayer({
                id: crypto.randomUUID(), name: npcData.name, role: npcData.role || 'PNJ', isNpc: true,
                level: npcData.level || 1, xp: 0,
                stats: { 
                    pv: npcData.stats?.maxPv||10, maxPv: npcData.stats?.maxPv||10, 
                    ca: npcData.stats?.ca||10, iniBase: npcData.stats?.iniBase||0, iniRoll: 0,
                    str: npcData.stats?.str||10, dex: npcData.stats?.dex||10, con: npcData.stats?.con||10,
                    int: npcData.stats?.int||10, wis: npcData.stats?.wis||10, cha: npcData.stats?.cha||10
                },
                notes: '', conditions: [], skills: [], inventory: [], spells: []
             });
             addChatMessage('system', `Nouveau PNJ invoqué: ${npcData.name}`);
          }
        } catch(e) { console.error(e); }
        updateState({ isGenerating: false });
      }

      // --- Gestion de l'état ---
      function updateState(newState) {
        state = { ...state, ...newState };
        render();
      }

      // --- Rendu Principal ---
      function render() {
        const app = document.getElementById('app');
        
        const header = `
          <header class="flex-none bg-slate-900 border-b border-slate-700 p-3 flex justify-between items-center shadow-md z-20">
            <div class="flex items-center gap-3">
                <div class="bg-fantasy-gold p-2 rounded-lg shadow-lg shadow-amber-500/20">
                    <i data-lucide="sword" class="text-white w-5 h-5"></i>
                </div>
                <h1 class="text-xl font-extrabold tracking-tight text-white hidden md:block">
                    JDR <span class="text-fantasy-gold">Compagnon</span>
                </h1>
            </div>
            
            <div class="flex items-center gap-4">
              <div class="flex bg-slate-800 rounded-lg p-1 border border-slate-700">
                <button onclick="window.appActions.setView('GM')" 
                  class="px-3 py-1.5 rounded text-xs font-bold uppercase tracking-wider transition-all flex items-center gap-2 ${state.viewMode === 'GM' ? 'bg-fantasy-panel text-fantasy-gold shadow' : 'text-slate-400 hover:text-white'}">
                  <i data-lucide="crown" class="w-4 h-4"></i> MJ
                </button>
                <button onclick="window.appActions.setView('PLAYER_SELECT')" 
                  class="px-3 py-1.5 rounded text-xs font-bold uppercase tracking-wider transition-all flex items-center gap-2 ${state.viewMode.startsWith('PLAYER') ? 'bg-fantasy-panel text-fantasy-gold shadow' : 'text-slate-400 hover:text-white'}">
                   <i data-lucide="users" class="w-4 h-4"></i> Joueur
                </button>
              </div>
              
              <button onclick="window.appActions.toggleChat()" class="text-slate-400 hover:text-fantasy-gold relative">
                 <i data-lucide="message-square" class="w-6 h-6"></i>
                 ${state.isChatOpen ? '' : '<span class="absolute top-0 right-0 w-2 h-2 bg-fantasy-gold rounded-full"></span>'}
              </button>
            </div>
          </header>
        `;

        let mainContent = '';
        if (state.viewMode === 'GM') {
            mainContent = renderGMView();
        } else if (state.viewMode === 'PLAYER_SELECT') {
            mainContent = renderPlayerSelect();
        } else if (state.viewMode === 'PLAYER_FOCUS') {
            mainContent = renderPlayerFocus();
        }

        app.innerHTML = `
          ${header}
          <div class="flex flex-1 overflow-hidden relative">
            <main class="flex-1 overflow-y-auto p-4 md:p-8 relative">
               ${mainContent}
            </main>
            <aside class="${state.isChatOpen ? 'w-80 translate-x-0' : 'w-0 translate-x-full'} transition-all duration-300 bg-slate-900 border-l border-slate-700 flex flex-col absolute right-0 top-0 bottom-0 z-30 shadow-2xl md:relative md:transform-none">
               <div id="chat-container-wrapper" class="h-full">
                 ${renderChat()}
               </div>
            </aside>
          </div>
        `;

        renderModal();
        lucide.createIcons();
        if(document.activeElement?.id === 'chat-input') document.getElementById('chat-input').focus();
      }

      // --- Vues ---

      function renderChat() {
        const messagesHtml = state.chatMessages.map(msg => `
            <div class="mb-4 ${msg.role === 'user' ? 'text-right' : 'text-left'}">
                <div class="inline-block max-w-[90%] p-3 rounded-lg text-sm ${
                    msg.role === 'user' ? 'bg-fantasy-gold text-white rounded-br-none' : 
                    msg.role === 'system' ? 'bg-slate-800 text-slate-400 text-xs italic border border-slate-700' : 
                    'bg-slate-700 text-slate-200 rounded-bl-none border border-slate-600'
                }">
                    ${msg.role === 'ai' ? `<div class="text-fantasy-gold text-[10px] font-bold mb-1 uppercase tracking-wider flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3"></i> Oracle</div>` : ''}
                    ${msg.text}
                </div>
            </div>
        `).join('');

        return `
            <div class="flex flex-col h-full bg-slate-900">
                <div class="p-3 border-b border-slate-700 flex justify-between items-center bg-slate-800">
                    <h3 class="font-bold text-slate-200 flex items-center gap-2 text-sm"><i data-lucide="scroll" class="w-4 h-4"></i> Journal & Oracle</h3>
                    <button onclick="window.appActions.toggleChat()" class="md:hidden text-slate-400"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <div id="chat-body" class="flex-1 overflow-y-auto p-4 bg-slate-900/50 custom-scrollbar">
                    ${messagesHtml}
                    ${state.isGenerating ? '<div class="text-xs text-fantasy-gold animate-pulse p-2">L\'oracle réfléchit...</div>' : ''}
                </div>
                <form onsubmit="window.appActions.sendChat(event)" class="p-3 bg-slate-800 border-t border-slate-700 flex gap-2">
                    <input id="chat-input" autocomplete="off" placeholder="Noter ou demander à l'IA..." class="flex-1 bg-slate-900 border border-slate-600 text-white text-sm rounded px-3 py-2 outline-none focus:border-fantasy-gold placeholder-slate-600">
                    <button type="submit" class="bg-fantasy-gold text-white p-2 rounded hover:bg-yellow-600 transition-colors"><i data-lucide="send" class="w-4 h-4"></i></button>
                </form>
            </div>
        `;
      }

      function renderGMView() {
        return `
          <div class="space-y-6 max-w-7xl mx-auto animate-fade-in pb-20">
            <div class="flex flex-wrap gap-4 items-center justify-between bg-fantasy-panel p-4 rounded-lg border border-slate-700 shadow-sm">
                <div class="flex gap-2 w-full md:w-auto">
                  <button onclick="window.appActions.addManualPlayer()" class="bg-fantasy-gold text-white hover:bg-yellow-600 px-3 py-2 rounded shadow-md text-sm font-bold flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Nouveau Perso</button>
                  <button onclick="window.appActions.createNpc()" class="bg-indigo-600 text-white hover:bg-indigo-700 px-3 py-2 rounded shadow-md flex items-center gap-1 text-xs font-bold uppercase"><i data-lucide="wand-2" class="w-4 h-4"></i> PNJ IA</button>
                </div>
                <button onclick="window.appActions.sortInitiative()" class="bg-slate-700 text-slate-200 hover:bg-slate-600 px-4 py-2 rounded text-sm font-medium shadow-md border border-slate-600 flex items-center gap-2">
                   <i data-lucide="arrow-down-narrow-wide" class="w-4 h-4"></i> Initiative
                </button>
            </div>

            <div class="overflow-x-auto bg-fantasy-panel rounded-lg shadow-xl border border-slate-700">
                <table class="w-full text-left text-sm whitespace-nowrap">
                  <thead class="bg-slate-800 text-slate-400 uppercase font-bold text-xs">
                    <tr>
                      <th class="p-4 w-12 text-center">Ini</th>
                      <th class="p-4">Héros</th>
                      <th class="p-4 text-center">Niv / XP</th>
                      <th class="p-4 text-center">Santé (PV)</th>
                      <th class="p-4 text-center">CA / DEX</th>
                      <th class="p-4">États</th>
                      <th class="p-4 text-right">Fiche</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-700">
                    ${state.players.map((p, idx) => renderGMRow(p, idx)).join('')}
                  </tbody>
                </table>
            </div>
          </div>
        `;
      }

      function renderGMRow(player, index) {
        const isDead = player.stats.pv <= 0;
        return `
          <tr class="hover:bg-slate-700/50 transition-colors ${isDead ? 'opacity-50 grayscale' : ''}">
            <td class="p-3 text-center">
               <div class="flex items-center justify-center gap-1">
                 <input type="number" value="${player.stats.iniRoll}" onchange="window.appActions.updateStat('${player.id}', 'iniRoll', parseInt(this.value))" class="input-ghost w-10 text-fantasy-gold font-bold bg-slate-900 border border-slate-700">
                 <span class="text-xs text-slate-500">+ ${player.stats.iniBase}</span>
               </div>
            </td>
            <td class="p-3">
               <input value="${player.name}" onchange="window.appActions.updatePlayer('${player.id}', 'name', this.value)" class="input-ghost font-bold block w-full text-left text-slate-200">
               <input value="${player.role}" onchange="window.appActions.updatePlayer('${player.id}', 'role', this.value)" class="input-ghost text-xs text-slate-400 block w-full text-left mt-1">
            </td>
            <td class="p-3 text-center">
                <div class="flex items-center justify-center gap-1">
                    <span class="text-xs text-slate-500">Niv</span>
                    <input type="number" value="${player.level}" onchange="window.appActions.updatePlayer('${player.id}', 'level', parseInt(this.value))" class="input-ghost w-8 font-bold text-white">
                </div>
                <div class="flex items-center justify-center gap-1 mt-1">
                    <input type="number" value="${player.xp}" onchange="window.appActions.updatePlayer('${player.id}', 'xp', parseInt(this.value))" class="input-ghost w-16 text-xs text-fantasy-gold">
                    <span class="text-[10px] text-slate-500">XP</span>
                </div>
            </td>
            <td class="p-3 text-center">
              <div class="flex items-center justify-center gap-1 bg-slate-900/50 rounded-full px-2 py-1 border border-slate-700 inline-flex">
                 <button onclick="window.appActions.updateStat('${player.id}', 'pv', ${player.stats.pv - 1})" class="text-red-400 hover:text-red-300 p-1"><i data-lucide="minus" class="w-3 h-3"></i></button>
                 <span class="font-mono font-bold w-8 text-right ${player.stats.pv < player.stats.maxPv/2 ? 'text-red-500' : 'text-green-400'}">${player.stats.pv}</span>
                 <span class="text-slate-500 text-xs">/</span>
                 <input type="number" value="${player.stats.maxPv}" onchange="window.appActions.updateStat('${player.id}', 'maxPv', parseInt(this.value))" class="input-ghost w-8 text-slate-500 text-xs">
                 <button onclick="window.appActions.updateStat('${player.id}', 'pv', ${player.stats.pv + 1})" class="text-green-400 hover:text-green-300 p-1"><i data-lucide="plus" class="w-3 h-3"></i></button>
              </div>
            </td>
            <td class="p-3 text-center">
               <div class="flex gap-2 justify-center text-xs">
                 <div class="flex flex-col items-center">
                    <span class="text-[10px] text-slate-500">CA</span>
                    <input type="number" value="${player.stats.ca}" onchange="window.appActions.updateStat('${player.id}', 'ca', parseInt(this.value))" class="input-ghost w-8 text-slate-300 font-bold bg-slate-800 rounded">
                 </div>
                 <div class="flex flex-col items-center">
                    <span class="text-[10px] text-slate-500">DEX</span>
                    <input type="number" value="${player.stats.dex}" onchange="window.appActions.updateStat('${player.id}', 'dex', parseInt(this.value))" class="input-ghost w-8 text-slate-400">
                 </div>
               </div>
            </td>
            <td class="p-3">
               <div class="flex flex-wrap gap-1 mb-1 max-w-[150px]">
                 ${player.conditions.map(c => `
                   <span class="text-[10px] bg-slate-800 text-red-300 px-2 py-0.5 rounded-full border border-red-900/50 cursor-pointer hover:bg-red-900" onclick="window.appActions.removeCondition('${player.id}', '${c}')">
                     ${c}
                   </span>
                 `).join('')}
               </div>
               <select onchange="window.appActions.addCondition('${player.id}', this.value)" class="bg-transparent text-xs text-slate-500 outline-none w-20 hover:text-slate-300">
                 <option value="">+ État</option>
                 ${CONDITIONS_LIST.map(c => `<option value="${c}">${c}</option>`).join('')}
               </select>
            </td>
            <td class="p-3 text-right">
              <button onclick="window.appActions.editPlayer('${player.id}')" class="bg-slate-700 hover:bg-fantasy-gold text-white px-3 py-1 rounded text-xs font-bold transition-colors">
                 <i data-lucide="scroll-text" class="w-4 h-4 inline mr-1"></i> Fiche
              </button>
            </td>
          </tr>
        `;
      }

      function renderPlayerSelect() {
        return `
          <div class="flex flex-col items-center justify-center h-full animate-fade-in">
             <h2 class="text-3xl font-bold text-white mb-8">Qui incarnez-vous ?</h2>
             <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 max-w-4xl w-full px-4">
               ${state.players.filter(p => !p.isNpc).map(p => `
                 <button onclick="window.appActions.selectPlayer('${p.id}')" class="group relative bg-fantasy-panel border-2 border-slate-700 hover:border-fantasy-gold rounded-xl p-8 transition-all hover:scale-105 hover:shadow-2xl hover:shadow-fantasy-gold/20 text-left">
                    <h3 class="text-2xl font-bold text-white group-hover:text-fantasy-gold">${p.name}</h3>
                    <p class="text-slate-400">${p.role} - Niv ${p.level}</p>
                    <div class="absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="arrow-right" class="w-6 h-6 text-fantasy-gold"></i>
                    </div>
                 </button>
               `).join('')}
             </div>
          </div>
        `;
      }

      function renderPlayerFocus() {
        const player = state.players.find(p => p.id === state.selectedPlayerId);
        if (!player) return `<div class="text-center mt-20">Joueur introuvable <button onclick="window.appActions.setView('PLAYER_SELECT')">Retour</button></div>`;
        
        const hpPercent = (player.stats.pv / player.stats.maxPv) * 100;

        // Helper pour l'animation flash
        const isUpdated = (field) => state.lastUpdated.id === player.id && state.lastUpdated.field === field ? 'flash-update' : '';

        return `
          <div class="max-w-2xl mx-auto h-full flex flex-col gap-6 animate-fade-in pb-10">
             <button onclick="window.appActions.setView('PLAYER_SELECT')" class="text-slate-500 hover:text-white flex items-center gap-2 text-sm uppercase font-bold tracking-widest mb-4">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Retour
             </button>

             <!-- Header Carte -->
             <div class="text-center space-y-2">
                <h2 class="text-4xl font-extrabold text-white tracking-tight ${isUpdated('name')}">${player.name}</h2>
                <div class="flex justify-center gap-4 text-sm font-semibold uppercase tracking-widest text-fantasy-gold">
                    <span>${player.role}</span>
                    <span class="${isUpdated('level')}">Niv ${player.level}</span>
                    <span class="text-slate-500 ${isUpdated('xp')}">${player.xp} XP</span>
                </div>
             </div>

             <!-- Big PV -->
             <div class="glass-panel p-8 rounded-2xl shadow-2xl relative overflow-hidden border-t-4 ${hpPercent < 30 ? 'border-red-500' : 'border-green-500'} ${isUpdated('pv')}">
                <div class="flex justify-between items-end mb-4 relative z-10">
                   <span class="text-slate-400 font-bold text-sm uppercase">Points de Vie</span>
                   <span class="text-5xl font-black text-white">${player.stats.pv} <span class="text-lg text-slate-500 font-normal">/ ${player.stats.maxPv}</span></span>
                </div>
                <div class="h-4 bg-slate-900 rounded-full overflow-hidden mb-6 border border-slate-700">
                    <div class="h-full transition-all duration-700 ${hpPercent < 30 ? 'bg-red-500' : 'bg-green-500'}" style="width: ${hpPercent}%"></div>
                </div>
                <div class="flex justify-between text-center gap-4">
                     <div class="bg-slate-800/50 p-2 rounded flex-1 ${isUpdated('ca')}">
                        <div class="text-xs text-slate-500 uppercase">CA</div>
                        <div class="font-bold text-xl text-white">${player.stats.ca}</div>
                     </div>
                     <div class="bg-slate-800/50 p-2 rounded flex-1 ${isUpdated('iniRoll')}">
                        <div class="text-xs text-slate-500 uppercase">Ini Total</div>
                        <div class="font-bold text-xl text-fantasy-gold">${player.stats.iniBase + player.stats.iniRoll}</div>
                     </div>
                </div>
             </div>

             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Inventaire & Armes -->
                <div class="bg-fantasy-panel rounded-xl border border-slate-700 p-4">
                    <h3 class="text-fantasy-gold text-xs font-bold uppercase mb-4 flex items-center gap-2 border-b border-slate-700 pb-2">
                        <i data-lucide="sword" class="w-4 h-4"></i> Armement & Sac
                    </h3>
                    <ul class="space-y-4">
                    ${player.inventory.map(item => `
                        <li class="border-b border-slate-800 pb-2 last:border-0">
                            <div class="flex justify-between items-center text-slate-300 mb-1">
                                <span class="font-bold flex items-center gap-2">
                                    <i data-lucide="${item.type === 'weapon' ? 'sword' : 'package'}" class="w-3 h-3 text-slate-500"></i>
                                    ${item.name}
                                </span>
                                <span class="font-mono text-fantasy-gold text-xs">x${item.qty}</span>
                            </div>
                            ${item.type === 'weapon' && item.data ? `
                            <div class="grid grid-cols-3 gap-1 text-[10px] text-center bg-slate-900/50 rounded p-1">
                                <div><span class="text-slate-500 block">ATK</span><span class="text-green-400 font-bold">${item.data.atk || '-'}</span></div>
                                <div><span class="text-slate-500 block">DMG</span><span class="text-red-400 font-bold">${item.data.dmg || '-'}</span></div>
                                <div><span class="text-slate-500 block">CRIT</span><span class="text-yellow-500 font-bold">${item.data.crit || '-'}</span></div>
                            </div>
                            ` : ''}
                        </li>
                    `).join('')}
                    </ul>
                </div>

                <!-- Grimoire -->
                <div class="bg-fantasy-panel rounded-xl border border-slate-700 p-4">
                    <h3 class="text-fantasy-gold text-xs font-bold uppercase mb-4 flex items-center gap-2 border-b border-slate-700 pb-2">
                        <i data-lucide="book" class="w-4 h-4"></i> Grimoire
                    </h3>
                     ${player.spells && player.spells.length > 0 ? `
                        <ul class="space-y-3">
                            ${player.spells.map(spell => `
                            <li class="bg-slate-900/30 p-2 rounded border border-slate-700/30">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-white font-bold text-sm">${spell.name}</span>
                                    <span class="text-[10px] bg-indigo-900 text-indigo-200 px-1.5 rounded">Niv ${spell.level}</span>
                                </div>
                                <div class="text-xs text-slate-400 italic mb-1">${spell.desc}</div>
                                <div class="flex gap-2 text-[10px]">
                                    <span class="text-red-400">Deg: ${spell.dmg}</span>
                                    <span class="text-slate-500">|</span>
                                    <span class="text-blue-400">Effet: ${spell.effect}</span>
                                </div>
                            </li>
                            `).join('')}
                        </ul>
                     ` : '<div class="text-slate-600 text-sm italic text-center">Aucun sort connu</div>'}
                </div>
             </div>
          </div>
        `;
      }

      function renderModal() {
        const container = document.getElementById('modal-container');
        if (!state.editingPlayerId) {
            container.innerHTML = '';
            return;
        }

        const player = state.players.find(p => p.id === state.editingPlayerId);
        if (!player) return;

        // Fonction helper pour les inputs de stats
        const statInput = (label, key) => `
            <div class="bg-slate-900 p-2 rounded border border-slate-700 flex flex-col items-center">
                <label class="text-[10px] text-slate-500 uppercase font-bold mb-1">${label}</label>
                <input type="number" value="${player.stats[key]}" 
                    onchange="window.appActions.updateStat('${player.id}', '${key}', parseInt(this.value))" 
                    class="input-ghost text-xl font-bold text-white w-full">
            </div>
        `;

        container.innerHTML = `
          <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
             <div class="bg-fantasy-panel w-full max-w-5xl max-h-[95vh] overflow-hidden rounded-xl border border-slate-600 shadow-2xl flex flex-col">
                <!-- Header: Identité -->
                <div class="p-4 border-b border-slate-700 bg-slate-800 flex justify-between items-start">
                    <div class="flex-1 mr-8">
                        <input value="${player.name}" onchange="window.appActions.updatePlayer('${player.id}', 'name', this.value)" class="input-ghost text-3xl font-extrabold text-white text-left w-full mb-1">
                        <div class="flex gap-4">
                            <input value="${player.role}" onchange="window.appActions.updatePlayer('${player.id}', 'role', this.value)" class="input-ghost text-sm text-fantasy-gold text-left w-1/3">
                            <div class="flex items-center gap-2 text-sm text-slate-400">
                                <span>Niv</span>
                                <input type="number" value="${player.level}" onchange="window.appActions.updatePlayer('${player.id}', 'level', parseInt(this.value))" class="input-ghost w-10 text-white font-bold border-b border-slate-600">
                                <span>XP</span>
                                <input type="number" value="${player.xp}" onchange="window.appActions.updatePlayer('${player.id}', 'xp', parseInt(this.value))" class="input-ghost w-16 text-white border-b border-slate-600">
                            </div>
                        </div>
                    </div>
                    <button onclick="window.appActions.closeModal()" class="text-slate-400 hover:text-white p-2 bg-slate-700 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>

                <div class="flex-1 overflow-y-auto custom-scrollbar p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
                    
                    <!-- Colonne Gauche: Stats Combat (4 cols) -->
                    <div class="lg:col-span-4 space-y-6">
                        <h3 class="text-fantasy-gold font-bold uppercase tracking-widest text-sm border-b border-slate-700 pb-2">Caractéristiques</h3>
                        
                        <div class="grid grid-cols-3 gap-2">
                            ${statInput('FOR', 'str')}
                            ${statInput('DEX', 'dex')}
                            ${statInput('CON', 'con')}
                            ${statInput('INT', 'int')}
                            ${statInput('SAG', 'wis')}
                            ${statInput('CHA', 'cha')}
                        </div>

                        <div class="grid grid-cols-3 gap-2 pt-2">
                            ${statInput('CA', 'ca')}
                            ${statInput('INI', 'iniBase')}
                            <div class="bg-slate-900 p-2 rounded border border-slate-700 flex flex-col items-center relative overflow-hidden">
                                <label class="text-[10px] text-slate-500 uppercase font-bold mb-1">PV Max</label>
                                <input type="number" value="${player.stats.maxPv}" onchange="window.appActions.updateStat('${player.id}', 'maxPv', parseInt(this.value))" class="input-ghost text-xl font-bold text-green-500 w-full">
                            </div>
                        </div>

                        <div class="pt-4">
                             <h4 class="text-xs text-slate-500 uppercase font-bold mb-2">Compétences</h4>
                             <div class="flex flex-wrap gap-2 mb-3">
                                ${player.skills.map(skill => `
                                    <span class="bg-slate-800 text-slate-200 px-3 py-1 rounded-full text-xs border border-slate-600 flex items-center gap-2 group">
                                        ${skill}
                                        <button onclick="window.appActions.removeSkill('${player.id}', '${skill}')" class="text-slate-500 group-hover:text-red-400 transition-colors">&times;</button>
                                    </span>
                                `).join('')}
                            </div>
                             <form onsubmit="window.appActions.addSkill(event, '${player.id}')" class="flex gap-2">
                                <input name="skillName" placeholder="+ Compétence" class="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-white outline-none focus:border-fantasy-gold" required>
                                <button type="submit" class="bg-slate-700 text-slate-300 px-2 py-1 rounded text-xs hover:bg-slate-600">+</button>
                            </form>
                        </div>

                        <div class="pt-2">
                             <h4 class="text-xs text-slate-500 uppercase font-bold mb-2">Notes</h4>
                             <textarea onchange="window.appActions.updatePlayer('${player.id}', 'notes', this.value)" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-slate-300 text-xs h-24 focus:border-fantasy-gold outline-none resize-none">${player.notes}</textarea>
                        </div>
                    </div>

                    <!-- Colonne Centre: Inventaire & Armes (4 cols) -->
                    <div class="lg:col-span-4 flex flex-col h-full">
                        <h3 class="text-fantasy-gold font-bold uppercase tracking-widest text-sm border-b border-slate-700 pb-2 mb-3">Inventaire & Armes</h3>
                        <div class="flex-1 overflow-y-auto space-y-3 pr-2 mb-4 max-h-[500px]">
                            ${player.inventory.map(item => `
                                <div class="bg-slate-900 p-3 rounded border border-slate-700/50 hover:border-slate-500 transition-colors group">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <i data-lucide="${item.type === 'weapon' ? 'sword' : 'package'}" class="w-4 h-4 text-slate-500"></i>
                                            <input value="${item.name}" onchange="window.appActions.updateItemField('${player.id}', '${item.id}', 'name', this.value)" class="input-ghost-left bg-transparent text-slate-200 font-medium text-sm w-32 outline-none">
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <div class="flex items-center bg-slate-800 rounded border border-slate-700">
                                                <button onclick="window.appActions.updateItemQty('${player.id}', '${item.id}', -1)" class="px-1.5 text-slate-400 hover:text-white">-</button>
                                                <span class="w-6 text-center text-xs font-mono text-fantasy-gold">${item.qty}</span>
                                                <button onclick="window.appActions.updateItemQty('${player.id}', '${item.id}', 1)" class="px-1.5 text-slate-400 hover:text-white">+</button>
                                            </div>
                                            <button onclick="window.appActions.deleteItem('${player.id}', '${item.id}')" class="text-slate-600 hover:text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                        </div>
                                    </div>
                                    ${item.type === 'weapon' ? `
                                    <div class="grid grid-cols-3 gap-2 pt-2 border-t border-slate-800 mt-2">
                                        <div>
                                            <label class="text-[9px] text-slate-500 block uppercase">ATK</label>
                                            <input placeholder="+0" value="${item.data?.atk || ''}" onchange="window.appActions.updateItemData('${player.id}', '${item.id}', 'atk', this.value)" class="w-full bg-slate-800 text-green-400 text-xs rounded px-1 text-center outline-none focus:ring-1 ring-fantasy-gold">
                                        </div>
                                        <div>
                                            <label class="text-[9px] text-slate-500 block uppercase">DMG</label>
                                            <input placeholder="1d6" value="${item.data?.dmg || ''}" onchange="window.appActions.updateItemData('${player.id}', '${item.id}', 'dmg', this.value)" class="w-full bg-slate-800 text-red-400 text-xs rounded px-1 text-center outline-none focus:ring-1 ring-fantasy-gold">
                                        </div>
                                        <div>
                                            <label class="text-[9px] text-slate-500 block uppercase">CRIT</label>
                                            <input placeholder="x2" value="${item.data?.crit || ''}" onchange="window.appActions.updateItemData('${player.id}', '${item.id}', 'crit', this.value)" class="w-full bg-slate-800 text-yellow-500 text-xs rounded px-1 text-center outline-none focus:ring-1 ring-fantasy-gold">
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                        <form onsubmit="window.appActions.addItem(event, '${player.id}')" class="flex gap-2">
                            <input name="itemName" placeholder="Nouvel objet..." class="flex-1 bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm text-white outline-none focus:border-fantasy-gold" required>
                            <select name="itemType" class="bg-slate-900 border border-slate-700 text-slate-300 text-xs rounded outline-none">
                                <option value="item">Objet</option>
                                <option value="weapon">Arme</option>
                            </select>
                            <button type="submit" class="bg-fantasy-gold text-white px-3 py-2 rounded text-sm hover:bg-yellow-600 font-bold">+</button>
                        </form>
                    </div>

                    <!-- Colonne Droite: Grimoire (4 cols) -->
                    <div class="lg:col-span-4 flex flex-col h-full">
                        <h3 class="text-fantasy-gold font-bold uppercase tracking-widest text-sm border-b border-slate-700 pb-2 mb-3">Grimoire & Sorts</h3>
                        <div class="flex-1 overflow-y-auto space-y-3 pr-2 mb-4 max-h-[500px]">
                            ${(player.spells || []).map(spell => `
                                <div class="bg-slate-900 p-3 rounded border border-slate-700/50 hover:border-slate-500 transition-colors">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex-1 mr-2">
                                            <input value="${spell.name}" onchange="window.appActions.updateSpell('${player.id}', '${spell.id}', 'name', this.value)" class="bg-transparent text-white font-bold text-sm w-full outline-none placeholder-slate-600" placeholder="Nom du sort">
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <span class="text-[10px] text-slate-500">Niv</span>
                                            <input type="number" value="${spell.level}" onchange="window.appActions.updateSpell('${player.id}', '${spell.id}', 'level', parseInt(this.value))" class="bg-slate-800 text-indigo-300 w-8 text-center text-xs rounded outline-none">
                                            <button onclick="window.appActions.removeSpell('${player.id}', '${spell.id}')" class="text-slate-600 hover:text-red-500 ml-1"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <textarea onchange="window.appActions.updateSpell('${player.id}', '${spell.id}', 'desc', this.value)" class="w-full bg-slate-800/50 text-slate-400 text-xs rounded p-1 outline-none resize-none h-12 placeholder-slate-600" placeholder="Description/Effet...">${spell.desc}</textarea>
                                        <div class="flex gap-2">
                                            <input value="${spell.dmg}" onchange="window.appActions.updateSpell('${player.id}', '${spell.id}', 'dmg', this.value)" class="flex-1 bg-slate-800 text-red-300 text-xs rounded px-2 py-1 outline-none placeholder-slate-600" placeholder="Dégâts (ex: 3d6)">
                                            <input value="${spell.effect}" onchange="window.appActions.updateSpell('${player.id}', '${spell.id}', 'effect', this.value)" class="flex-1 bg-slate-800 text-blue-300 text-xs rounded px-2 py-1 outline-none placeholder-slate-600" placeholder="Type/Sauvegarde">
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="window.appActions.addSpell('${player.id}')" class="bg-slate-800 border border-dashed border-slate-600 text-slate-400 hover:text-white hover:border-slate-400 w-full py-2 rounded text-sm transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i> Ajouter un sort
                        </button>
                    </div>

                </div>
             </div>
          </div>
        `;
      }

      // --- Actions ---
      window.appActions = {
        setView: (mode) => {
            if(mode === 'PLAYER_SELECT') updateState({ viewMode: mode, selectedPlayerId: null });
            else updateState({ viewMode: mode });
        },
        toggleChat: () => updateState({ isChatOpen: !state.isChatOpen }),
        selectPlayer: (id) => updateState({ selectedPlayerId: id, viewMode: 'PLAYER_FOCUS' }),
        editPlayer: (id) => updateState({ editingPlayerId: id }),
        closeModal: () => updateState({ editingPlayerId: null }),

        // Core Updates avec Tracking pour Animation
        updatePlayer: (id, field, value) => {
          const players = state.players.map(p => p.id === id ? { ...p, [field]: value } : p);
          updateState({ players, lastUpdated: { id, field, time: Date.now() } });
        },

        updateStat: (id, stat, value) => {
          const players = state.players.map(p => {
             if (p.id !== id) return p;
             let newValue = value;
             if (stat === 'pv') newValue = Math.min(p.stats.maxPv, Math.max(0, value)); // Cap PV at MaxPV
             return { ...p, stats: { ...p.stats, [stat]: newValue } };
          });
          updateState({ players, lastUpdated: { id, field: stat, time: Date.now() } });
        },

        addCondition: (id, condition) => {
          if (!condition) return;
          const players = state.players.map(p => {
            if (p.id !== id || p.conditions.includes(condition)) return p;
            return { ...p, conditions: [...p.conditions, condition] };
          });
          updateState({ players });
        },

        removeCondition: (id, condition) => {
          const players = state.players.map(p => 
            p.id === id ? { ...p, conditions: p.conditions.filter(c => c !== condition) } : p
          );
          updateState({ players });
        },

        removePlayer: (id) => {
          if(confirm('Supprimer ce personnage ?')) {
            updateState({ players: state.players.filter(p => p.id !== id) });
          }
        },

        sortInitiative: () => {
          const players = [...state.players].sort((a, b) => {
             return (b.stats.iniBase + b.stats.iniRoll) - (a.stats.iniBase + a.stats.iniRoll);
          });
          updateState({ players });
        },

        addManualPlayer: () => {
          const name = prompt("Nom du personnage ?") || "Nouveau";
          addPlayer({
            id: crypto.randomUUID(), name, role: 'Classe', isNpc: false, level: 1, xp: 0,
            stats: { pv: 10, maxPv: 10, ca: 10, iniBase: 0, iniRoll: 0, str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10 },
            notes: '', conditions: [], skills: [], inventory: [], spells: []
          });
        },
        createNpc: generateNpc,

        addItem: (e, playerId) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const type = formData.get('itemType');
            const newItem = {
                id: crypto.randomUUID(),
                name: formData.get('itemName'),
                type: type,
                qty: 1,
                data: type === 'weapon' ? { atk: '', dmg: '', crit: '' } : {}
            };
            const players = state.players.map(p => p.id === playerId ? { ...p, inventory: [...p.inventory, newItem] } : p);
            updateState({ players });
            e.target.reset();
            renderModal();
        },
        updateItemQty: (playerId, itemId, change) => {
            const players = state.players.map(p => {
                if (p.id !== playerId) return p;
                const newInventory = p.inventory.map(i => {
                    if (i.id !== itemId) return i;
                    return { ...i, qty: Math.max(0, i.qty + change) };
                }).filter(i => i.qty > 0);
                return { ...p, inventory: newInventory };
            });
            updateState({ players });
            renderModal();
        },
        updateItemField: (playerId, itemId, field, value) => {
            const players = state.players.map(p => {
                if (p.id !== playerId) return p;
                const newInventory = p.inventory.map(i => i.id === itemId ? { ...i, [field]: value } : i);
                return { ...p, inventory: newInventory };
            });
            updateState({ players });
            // Don't re-render modal fully if typing to keep focus? 
            // Actually re-rendering modal might lose focus. Let's rely on simple updateState but we need to keep focus.
            // For now, the implementation does re-render. Ideally we should optimize.
        },
        updateItemData: (playerId, itemId, key, value) => {
            const players = state.players.map(p => {
                if (p.id !== playerId) return p;
                const newInventory = p.inventory.map(i => {
                    if (i.id !== itemId) return i;
                    return { ...i, data: { ...i.data, [key]: value } };
                });
                return { ...p, inventory: newInventory };
            });
            // Update state without full modal re-render to allow typing? 
            // state update triggers render() which triggers renderModal().
            // This causes focus loss.
            // FIX: We update state silently or use a different mechanism?
            // For this quick prototype, we updateState. The focus loss is an issue.
            // Let's NOT call updateState on every keystroke if possible, OR, we need to handle focus.
            // The simplest fix for "Vanilla JS" reactivity without VDOM is difficult.
            // However, the previous 'input-ghost' worked because render happened.
            // I will update the state variable `state` directly but NOT call `render()` for these specific inputs, 
            // since the input value is already updated by the user typing in it.
            // We only need to persist it to state.
            
            // Hacky fix for focus loss in Vanilla JS:
            const player = state.players.find(p => p.id === playerId);
            const item = player.inventory.find(i => i.id === itemId);
            if(item) {
                if(!item.data) item.data = {};
                item.data[key] = value;
            }
            // We do NOT call updateState({}) here to avoid re-render.
        },
        deleteItem: (playerId, itemId) => {
            const players = state.players.map(p => {
                if(p.id !== playerId) return p;
                return { ...p, inventory: p.inventory.filter(i => i.id !== itemId) };
            });
            updateState({ players });
            renderModal();
        },
        addSkill: (e, playerId) => {
            e.preventDefault();
            const val = new FormData(e.target).get('skillName');
            if(!val) return;
            const players = state.players.map(p => p.id === playerId ? { ...p, skills: [...p.skills, val] } : p);
            updateState({ players });
            e.target.reset();
            renderModal();
        },
        removeSkill: (playerId, skillName) => {
            const players = state.players.map(p => p.id === playerId ? { ...p, skills: p.skills.filter(s => s !== skillName) } : p);
            updateState({ players });
            renderModal();
        },
        
        // Spell Actions
        addSpell: (playerId) => {
            const newSpell = { id: crypto.randomUUID(), name: '', level: 1, desc: '', dmg: '', effect: '' };
            const players = state.players.map(p => p.id === playerId ? { ...p, spells: [...(p.spells||[]), newSpell] } : p);
            updateState({ players });
            renderModal();
        },
        updateSpell: (playerId, spellId, field, value) => {
            // Same focus optimization: modify state directly
             const player = state.players.find(p => p.id === playerId);
             const spell = player.spells.find(s => s.id === spellId);
             if(spell) spell[field] = value;
             // No render call
        },
        removeSpell: (playerId, spellId) => {
             const players = state.players.map(p => p.id === playerId ? { ...p, spells: p.spells.filter(s => s.id !== spellId) } : p);
             updateState({ players });
             renderModal();
        },

        sendChat: (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;
            if(text.startsWith('?')) askAI(text.substring(1).trim());
            else addChatMessage('user', text);
            input.value = '';
        }
      };

      function addPlayer(player) {
        updateState({ players: [...state.players, player] });
      }

      render();
    </script>
</body>
</html>