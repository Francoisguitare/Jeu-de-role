<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>JDR Compagnon</title>
    
    <!-- Styles: Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              fantasy: {
                dark: '#0f172a',
                panel: '#1e293b',
                gold: '#d97706',
                danger: '#ef4444',
                success: '#22c55e',
                text: '#e2e8f0'
              }
            }
          }
        }
      }
    </script>
    
    <!-- Icons: Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Import Map pour le SDK Gemini -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0"
  }
}
</script>

    <style>
      /* Scrollbar personnalisée */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #0f172a; }
      ::-webkit-scrollbar-thumb { background: #1e293b; border: 1px solid #334155; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #334155; }
      
      /* Utilitaires */
      .input-std {
        background-color: transparent;
        border-bottom: 1px solid transparent;
        outline: none;
      }
      .input-std:focus {
        border-bottom-color: #d97706;
      }
    </style>
</head>
<body class="bg-fantasy-dark text-fantasy-text min-h-screen font-sans">
    
    <!-- Container Principal -->
    <div id="app" class="p-4 md:p-8 max-w-7xl mx-auto">
        <!-- Le contenu sera injecté ici par JavaScript -->
        <div class="text-center text-slate-500 mt-20">Chargement du grimoire...</div>
    </div>

    <!-- Logique de l'application -->
    <script type="module">
      import { GoogleGenAI, Type } from "@google/genai";
      
      // --- Configuration ---
      // NOTE: Dans un environnement web pur sans bundler, process peut ne pas être défini.
      // Assurez-vous que votre environnement injecte API_KEY.
      const API_KEY = (typeof process !== 'undefined' && process.env) ? process.env.API_KEY : '';
      const ai = new GoogleGenAI({ apiKey: API_KEY });

      // --- Constantes & Données Initiales ---
      const CONDITIONS_LIST = ['Empoisonné', 'Étourdi', 'À terre', 'Aveuglé', 'Charmé'];
      
      const INITIAL_PLAYERS = [
        { id: '1', name: 'Grommash', role: 'Barbare', isNpc: false, stats: { pv: 45, maxPv: 45, dex: 12, iniBase: 2, iniRoll: 0 }, notes: 'Rage disponible', conditions: [] },
        { id: '2', name: 'Elara', role: 'Mage', isNpc: false, stats: { pv: 22, maxPv: 22, dex: 16, iniBase: 4, iniRoll: 0 }, notes: 'Sorts niv 2', conditions: [] },
        { id: '3', name: 'Gobelin Chef', role: 'Monstre', isNpc: true, stats: { pv: 15, maxPv: 15, dex: 14, iniBase: 3, iniRoll: 0 }, notes: 'Lâche', conditions: [] }
      ];

      // --- État Global (State) ---
      let state = {
        players: [...INITIAL_PLAYERS],
        viewMode: 'GM', // 'GM' | 'PLAYER'
        isGenerating: false,
        scenarioText: '',
        newPlayerName: ''
      };

      // --- Services Gemini ---
      
      async function generateNpc() {
        if (!API_KEY) { alert("API Key manquante"); return; }
        updateState({ isGenerating: true });
        
        try {
          const response = await ai.models.generateContent({
            model: 'gemini-3-flash-preview',
            contents: `Génère un PNJ (Personnage Non Joueur) pour un jeu de rôle médiéval fantastique. 
            Réponds UNIQUEMENT avec un objet JSON valide contenant: name, role, stats (maxPv, dex, iniBase), notes.`,
            config: {
              responseMimeType: "application/json",
              responseSchema: {
                type: Type.OBJECT,
                properties: {
                  name: { type: Type.STRING },
                  role: { type: Type.STRING },
                  stats: {
                    type: Type.OBJECT,
                    properties: {
                      maxPv: { type: Type.INTEGER },
                      dex: { type: Type.INTEGER },
                      iniBase: { type: Type.INTEGER }
                    }
                  },
                  notes: { type: Type.STRING }
                }
              }
            }
          });
          
          const npcData = JSON.parse(response.text || '{}');
          if (npcData.name) {
             const newPlayer = {
                id: crypto.randomUUID(),
                name: npcData.name,
                role: npcData.role || 'PNJ',
                isNpc: true,
                stats: {
                  pv: npcData.stats?.maxPv || 10,
                  maxPv: npcData.stats?.maxPv || 10,
                  dex: npcData.stats?.dex || 10,
                  iniBase: npcData.stats?.iniBase || 0,
                  iniRoll: 0
                },
                notes: npcData.notes || '',
                conditions: []
             };
             addPlayer(newPlayer);
          }
        } catch (e) {
          console.error(e);
          alert("Erreur d'invocation Gemini.");
        }
        updateState({ isGenerating: false });
      }

      async function generateScenarioHook() {
        if (!API_KEY) { alert("API Key manquante"); return; }
        updateState({ isGenerating: true });
        
        try {
          const names = state.players.map(p => p.name).join(', ');
          const response = await ai.models.generateContent({
            model: 'gemini-3-flash-preview',
            contents: `Agis comme un Maître de Jeu. Donne une courte phrase d'ambiance pour une scène avec: ${names}.`,
            config: { maxOutputTokens: 100 }
          });
          updateState({ isGenerating: false, scenarioText: response.text });
        } catch (e) {
          console.error(e);
          updateState({ isGenerating: false, scenarioText: "L'oracle est silencieux." });
        }
      }

      // --- Gestion de l'état et Rendu ---

      function updateState(newState) {
        state = { ...state, ...newState };
        render();
      }

      function render() {
        const app = document.getElementById('app');
        
        // Template Header
        const header = `
          <header class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
            <div class="flex items-center gap-3">
                <div class="bg-fantasy-gold p-2 rounded-full shadow-lg shadow-amber-500/20">
                    <i data-lucide="sword" class="text-white w-6 h-6"></i>
                </div>
                <h1 class="text-3xl font-extrabold tracking-tight text-white">
                    JDR <span class="text-fantasy-gold">Compagnon</span>
                </h1>
            </div>
            <div class="flex bg-slate-800 rounded-lg p-1 border border-slate-700">
              <button onclick="window.appActions.setView('GM')" 
                class="px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-2 ${state.viewMode === 'GM' ? 'bg-fantasy-panel text-fantasy-gold shadow-sm' : 'text-slate-400 hover:text-white'}">
                <i data-lucide="sword" class="w-4 h-4"></i> MJ
              </button>
              <button onclick="window.appActions.setView('PLAYER')" 
                class="px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-2 ${state.viewMode === 'PLAYER' ? 'bg-fantasy-panel text-fantasy-gold shadow-sm' : 'text-slate-400 hover:text-white'}">
                 <i data-lucide="users" class="w-4 h-4"></i> Joueurs
              </button>
            </div>
          </header>
        `;

        // Template Footer
        const footer = `
          <footer class="mt-12 text-center text-slate-600 text-sm">
            <p>Propulsé par Gemini 2.5 Flash • Vanilla JS Edition</p>
          </footer>
        `;

        // Injection du contenu
        app.innerHTML = `
          ${header}
          <main class="mt-8 min-h-[500px]">
            ${state.viewMode === 'GM' ? renderGMView() : renderPlayerView()}
          </main>
          ${footer}
        `;
        
        // Initialisation des icônes
        lucide.createIcons();
      }

      // --- Vues Spécifiques ---

      function renderGMView() {
        return `
          <div class="space-y-6">
            <!-- AI Panel -->
            <div class="bg-fantasy-panel p-4 rounded-lg border border-slate-700">
                <h3 class="text-lg font-bold text-fantasy-gold mb-4 flex items-center gap-2">
                  <i data-lucide="sparkles" class="w-5 h-5"></i> Outils du MJ (IA)
                </h3>
                <div class="flex flex-wrap gap-4 items-start">
                    <button onclick="window.appActions.createNpc()" ${state.isGenerating ? 'disabled' : ''} class="bg-fantasy-panel border border-slate-600 text-slate-200 hover:bg-slate-700 px-4 py-2 text-sm rounded transition-colors disabled:opacity-50">
                       ${state.isGenerating ? 'Invocation...' : 'Générer un PNJ aléatoire'}
                    </button>
                    <button onclick="window.appActions.createHook()" ${state.isGenerating ? 'disabled' : ''} class="bg-fantasy-panel border border-slate-600 text-slate-200 hover:bg-slate-700 px-4 py-2 text-sm rounded transition-colors disabled:opacity-50">
                       ${state.isGenerating ? 'Divination...' : 'Inspirer une scène'}
                    </button>
                </div>
                ${state.scenarioText ? `<div class="mt-4 p-3 bg-slate-800 rounded text-slate-300 italic text-sm border-l-2 border-fantasy-gold">"${state.scenarioText}"</div>` : ''}
            </div>

            <!-- Controls -->
            <div class="flex flex-wrap gap-4 items-center justify-between">
                <div class="flex gap-2">
                  <input type="text" id="newPlayerInput" placeholder="Nom du nouveau..." class="bg-slate-800 border border-slate-600 text-white px-3 py-1 rounded text-sm focus:border-fantasy-gold outline-none">
                  <button onclick="window.appActions.addManualPlayer()" class="bg-fantasy-gold text-white hover:bg-yellow-600 px-3 py-1 rounded shadow-md"><i data-lucide="plus" class="w-4 h-4"></i></button>
                </div>
                <button onclick="window.appActions.sortInitiative()" class="bg-fantasy-gold text-white hover:bg-yellow-600 px-4 py-2 rounded text-sm font-medium shadow-md">Trier par Initiative</button>
            </div>

            <!-- Table -->
            <div class="overflow-x-auto bg-fantasy-panel rounded-lg shadow-xl border border-slate-700">
                <table class="w-full text-left text-sm">
                  <thead class="bg-slate-800 text-slate-400 uppercase font-bold text-xs">
                    <tr>
                      <th class="p-3">#</th>
                      <th class="p-3">Nom / Classe</th>
                      <th class="p-3 text-center">PV / Max</th>
                      <th class="p-3 text-center">DEX</th>
                      <th class="p-3 text-center">Total Ini</th>
                      <th class="p-3">Conditions</th>
                      <th class="p-3 text-right">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-700">
                    ${state.players.map((p, idx) => renderPlayerRow(p, idx)).join('')}
                  </tbody>
                </table>
            </div>
          </div>
        `;
      }

      function renderPlayerRow(player, index) {
        const isDead = player.stats.pv <= 0;
        return `
          <tr class="hover:bg-slate-700/50 transition-colors ${isDead ? 'opacity-50 grayscale' : ''}">
            <td class="p-3 font-mono text-fantasy-gold text-lg font-bold">#${index + 1}</td>
            <td class="p-3">
               <input value="${player.name}" onchange="window.appActions.updatePlayer('${player.id}', 'name', this.value)" class="input-std font-bold block w-full text-slate-200">
               <input value="${player.role}" onchange="window.appActions.updatePlayer('${player.id}', 'role', this.value)" class="input-std text-xs text-slate-400 block w-full">
            </td>
            <td class="p-3 text-center">
              <div class="flex items-center justify-center gap-1">
                 <button onclick="window.appActions.updateStat('${player.id}', 'pv', ${player.stats.pv - 1})" class="text-red-400 hover:bg-red-900/30 rounded p-1"><i data-lucide="chevron-down" class="w-3 h-3"></i></button>
                 <span class="w-8 text-center text-slate-200">${player.stats.pv}</span>
                 <span class="text-slate-500">/</span>
                 <input type="number" value="${player.stats.maxPv}" onchange="window.appActions.updateStat('${player.id}', 'maxPv', parseInt(this.value))" class="w-8 text-center bg-transparent border-b border-transparent text-slate-400">
                 <button onclick="window.appActions.updateStat('${player.id}', 'pv', ${player.stats.pv + 1})" class="text-green-400 hover:bg-green-900/30 rounded p-1"><i data-lucide="chevron-up" class="w-3 h-3"></i></button>
              </div>
            </td>
            <td class="p-3 text-center">
               <input type="number" value="${player.stats.dex}" onchange="window.appActions.updateStat('${player.id}', 'dex', parseInt(this.value))" class="w-10 text-center bg-transparent border-b border-slate-700 text-slate-300">
            </td>
            <td class="p-3 text-center">
              <div class="flex items-center justify-center gap-2">
                 <span class="text-slate-400 text-xs">${player.stats.iniBase} +</span>
                 <input type="number" value="${player.stats.iniRoll}" onchange="window.appActions.updateStat('${player.id}', 'iniRoll', parseInt(this.value))" class="w-10 text-center bg-slate-900 border border-slate-600 rounded py-1 text-fantasy-gold font-bold">
                 <span class="font-bold text-lg w-6 text-right">${player.stats.iniBase + player.stats.iniRoll}</span>
              </div>
            </td>
            <td class="p-3">
               <div class="flex flex-wrap gap-1 mb-1">
                 ${player.conditions.map(c => `
                   <span class="text-[10px] bg-red-900/50 text-red-200 px-1 rounded flex items-center gap-1 border border-red-800 cursor-pointer hover:bg-red-900" onclick="window.appActions.removeCondition('${player.id}', '${c}')">
                     ${c} &times;
                   </span>
                 `).join('')}
               </div>
               <select onchange="window.appActions.addCondition('${player.id}', this.value)" class="bg-slate-900 border border-slate-700 text-xs rounded p-1 w-24 text-slate-400">
                 <option value="">+ État</option>
                 ${CONDITIONS_LIST.map(c => `<option value="${c}">${c}</option>`).join('')}
               </select>
            </td>
            <td class="p-3 text-right">
              <button onclick="window.appActions.removePlayer('${player.id}')" class="text-slate-500 hover:text-red-500"><i data-lucide="trash" class="w-4 h-4"></i></button>
            </td>
          </tr>
        `;
      }

      function renderPlayerView() {
        return `
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${state.players.map((player, index) => {
              const hpPercent = (player.stats.pv / player.stats.maxPv) * 100;
              const isDead = player.stats.pv <= 0;
              const isFirst = index === 0;
              
              return `
                <div class="relative overflow-hidden rounded-xl border-2 transition-all duration-300 ${isDead ? 'border-slate-800 bg-slate-900 opacity-75' : isFirst ? 'border-fantasy-gold bg-fantasy-panel shadow-lg shadow-fantasy-gold/20 scale-105 z-10' : 'border-slate-700 bg-fantasy-panel'}">
                  <div class="absolute top-0 right-0 p-3">
                    <span class="text-2xl font-bold font-mono opacity-50 ${isFirst ? 'text-fantasy-gold' : 'text-slate-600'}">#${index + 1}</span>
                  </div>
                  <div class="p-6 space-y-4">
                    <div>
                      <h3 class="text-2xl font-bold truncate ${isDead ? 'text-slate-500 line-through' : 'text-white'}">${player.name}</h3>
                      <p class="text-slate-400 text-sm">${player.role}</p>
                    </div>
                    <div class="space-y-1">
                      <div class="flex justify-between text-sm">
                        <span class="flex items-center gap-1 text-slate-300"><i data-lucide="heart" class="w-3 h-3 text-red-500"></i> PV</span>
                        <span class="${isDead ? 'text-red-600 font-bold' : 'text-white'}">${player.stats.pv} / ${player.stats.maxPv}</span>
                      </div>
                      <div class="h-3 bg-slate-800 rounded-full overflow-hidden border border-slate-700">
                        <div class="h-full transition-all duration-500 ${hpPercent < 30 ? 'bg-red-600' : 'bg-green-600'}" style="width: ${Math.max(0, hpPercent)}%"></div>
                      </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-4">
                      <div class="bg-slate-800/50 p-3 rounded border border-slate-700 flex flex-col items-center">
                        <span class="text-xs text-slate-400 uppercase flex items-center gap-1"><i data-lucide="zap" class="w-3 h-3"></i> Initiative</span>
                        <span class="text-xl font-bold text-fantasy-gold">${player.stats.iniBase + player.stats.iniRoll}</span>
                      </div>
                      <div class="bg-slate-800/50 p-3 rounded border border-slate-700 flex flex-col items-center">
                         <span class="text-xs text-slate-400 uppercase flex items-center gap-1"><i data-lucide="shield-alert" class="w-3 h-3"></i> DEX</span>
                         <span class="text-lg font-bold text-slate-200">${player.stats.dex}</span>
                      </div>
                    </div>
                    ${player.conditions.length > 0 ? `
                      <div class="pt-2">
                        <p class="text-xs text-slate-500 mb-1">États actuels:</p>
                        <div class="flex flex-wrap gap-2">
                          ${player.conditions.map(c => `<span class="px-2 py-1 bg-red-900/30 border border-red-800 text-red-300 text-xs rounded-full">${c}</span>`).join('')}
                        </div>
                      </div>
                    ` : ''}
                  </div>
                  ${isDead ? `<div class="absolute inset-0 flex items-center justify-center bg-black/60 pointer-events-none"><i data-lucide="skull" class="w-16 h-16 text-slate-600 opacity-50"></i></div>` : ''}
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      // --- Actions Globales (Exposées à Window) ---

      window.appActions = {
        setView: (mode) => updateState({ viewMode: mode }),
        
        updatePlayer: (id, field, value) => {
          const players = state.players.map(p => p.id === id ? { ...p, [field]: value } : p);
          updateState({ players });
        },

        updateStat: (id, stat, value) => {
          const players = state.players.map(p => {
             if (p.id !== id) return p;
             let newValue = value;
             if (stat === 'pv') newValue = Math.min(p.stats.maxPv, Math.max(0, value));
             return { ...p, stats: { ...p.stats, [stat]: newValue } };
          });
          updateState({ players });
        },

        addCondition: (id, condition) => {
          if (!condition) return;
          const players = state.players.map(p => {
            if (p.id !== id || p.conditions.includes(condition)) return p;
            return { ...p, conditions: [...p.conditions, condition] };
          });
          updateState({ players });
        },

        removeCondition: (id, condition) => {
          const players = state.players.map(p => 
            p.id === id ? { ...p, conditions: p.conditions.filter(c => c !== condition) } : p
          );
          updateState({ players });
        },

        removePlayer: (id) => {
          if(confirm('Supprimer ce personnage ?')) {
            updateState({ players: state.players.filter(p => p.id !== id) });
          }
        },

        sortInitiative: () => {
          const players = [...state.players].sort((a, b) => {
             return (b.stats.iniBase + b.stats.iniRoll) - (a.stats.iniBase + a.stats.iniRoll);
          });
          updateState({ players });
        },

        addManualPlayer: () => {
          const input = document.getElementById('newPlayerInput');
          const name = input.value.trim();
          if (!name) return;
          addPlayer({
            id: crypto.randomUUID(),
            name: name,
            role: 'Inconnu',
            isNpc: true,
            stats: { pv: 20, maxPv: 20, dex: 10, iniBase: 0, iniRoll: 0 },
            notes: '',
            conditions: []
          });
        },

        createNpc: generateNpc,
        createHook: generateScenarioHook
      };

      function addPlayer(player) {
        updateState({ players: [...state.players, player] });
      }

      // Démarrage
      render();

    </script>
</body>
</html>